<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="title">Makeup Bot Control Center</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --bg-primary: #000000;
      --bg-secondary: #0a0a0a;
      --bg-card: #1a1a1a;
      --text-primary: #ffffff;
      --text-secondary: #a0a0a0;
      --accent-cyan: #00ffff;
      --accent-purple: #ff00ff;
      --accent-green: #00ff00;
      --accent-red: #ff0000;
      --border-color: rgba(255, 255, 255, 0.1);
      --shadow-glow: 0 0 20px rgba(0, 255, 255, 0.3);
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }
    
    /* é¡¶éƒ¨å¯¼èˆªæ  */
    .navbar {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(20px) saturate(180%);
      border-bottom: 1px solid var(--border-color);
      padding: 0 40px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .navbar-brand {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
      text-decoration: none;
      letter-spacing: -0.5px;
    }
    
    .navbar-actions {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .lang-switcher {
      display: flex;
      gap: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 4px;
    }
    
    .lang-btn {
      padding: 6px 12px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .lang-btn.active {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }
    
    .lang-btn:hover {
      color: var(--text-primary);
    }
    
    .btn-logout {
      padding: 8px 16px;
      background: rgba(255, 0, 0, 0.1);
      border: 1px solid rgba(255, 0, 0, 0.3);
      color: var(--accent-red);
      cursor: pointer;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .btn-logout:hover {
      background: rgba(255, 0, 0, 0.2);
      border-color: rgba(255, 0, 0, 0.5);
      box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
    }
    
    .btn-admin {
      padding: 8px 16px;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
      color: #000;
      border: none;
      border-radius: 8px;
      text-decoration: none;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn-admin:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 255, 255, 0.3);
    }
    
    /* ä¸»å®¹å™¨ */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 60px 40px;
    }
    
    /* æ ‡é¢˜åŒºåŸŸ */
    .hero-section {
      text-align: center;
      margin-bottom: 80px;
    }
    
    .hero-title {
      font-size: 56px;
      font-weight: 700;
      letter-spacing: -2px;
      margin-bottom: 16px;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .hero-subtitle {
      font-size: 20px;
      color: var(--text-secondary);
      font-weight: 400;
    }
    
    /* æ§åˆ¶é¢æ¿ */
    .control-section {
      margin-bottom: 80px;
    }
    
    .section-title {
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 24px;
      letter-spacing: -1px;
    }
    
    .control-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .btn-primary {
      grid-column: 1 / -1;
      padding: 16px 32px;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
      color: #000;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-glow);
    }
    
    .btn-module {
      padding: 20px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      text-align: left;
    }
    
    .btn-module:hover {
      border-color: var(--accent-cyan);
      background: rgba(0, 255, 255, 0.05);
      transform: translateY(-2px);
    }
    
    /* æ•°æ®å¡ç‰‡åŒºåŸŸ */
    .data-section {
      margin-bottom: 80px;
    }
    .tab-nav {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }
    .tab-btn {
      padding: 10px 18px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    .tab-btn.active {
      border-color: var(--accent-cyan);
      box-shadow: var(--shadow-glow);
    }
    
    /* åˆ†é¡µ */
    .pagination {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin: 24px 0;
      padding: 10px 14px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      color: var(--text-secondary);
    }
    .pagination .page-info {
      color: var(--text-secondary);
      font-weight: 500;
    }
    .pagination .page-btn {
      min-width: 34px;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--bg-card);
      color: var(--text-primary);
      text-decoration: none;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
    }
    .pagination .page-btn:hover {
      border-color: var(--accent-cyan);
      box-shadow: var(--shadow-glow);
    }
    .pagination .page-btn.active {
      border-color: var(--accent-cyan);
      background: rgba(0, 255, 255, 0.1);
      color: var(--text-primary);
      box-shadow: var(--shadow-glow);
    }
    .pagination .ellipsis {
      color: var(--text-secondary);
      padding: 0 4px;
    }
    .pagination-row {
      display: flex;
      align-items: center;
      gap: 16px;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    
    .data-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    
    .inline-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      padding: 12px 14px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      box-shadow: var(--shadow-soft);
    }
    
    /* ç­›é€‰å™¨æ ·å¼ */
    .filter-container {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 200px;
    }
    
    .filter-label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .filter-input {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      border-radius: 8px;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s;
    }
    
    .filter-input:focus {
      outline: none;
      border-color: var(--accent-cyan);
      box-shadow: 0 0 0 3px rgba(0, 255, 255, 0.1);
    }
    
    .filter-input::-webkit-calendar-picker-indicator {
      filter: invert(1);
      cursor: pointer;
      opacity: 0.8;
    }
    
    .filter-input::-webkit-calendar-picker-indicator:hover {
      opacity: 1;
    }
    
    .btn-filter {
      padding: 10px 20px;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
      color: #000;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    .btn-filter:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 255, 255, 0.3);
    }
    
    .btn-filter-reset {
      padding: 10px 20px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    .btn-filter-reset:hover {
      border-color: var(--accent-cyan);
      background: rgba(0, 255, 255, 0.05);
    }
    
    .data-count {
      font-size: 14px;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    /* å¡ç‰‡ç½‘æ ¼ */
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .data-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      transition: all 0.3s;
    }
    
    .data-card:hover {
      border-color: var(--accent-cyan);
      transform: translateY(-4px);
      box-shadow: var(--shadow-glow);
    }
    
    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--accent-cyan);
    }
    
    .card-content {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.8;
    }
    
    .card-label {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    
    .card-value {
      font-size: 16px;
      color: var(--text-primary);
      font-weight: 500;
      margin-bottom: 16px;
    }
    
    /* è¡¨æ ¼æ ·å¼ */
    .data-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
    }
    
    .data-table thead {
      background: rgba(255, 255, 255, 0.03);
    }
    
    .data-table th {
      padding: 16px 20px;
      text-align: left;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .data-table td {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-primary);
      font-size: 14px;
    }
    
    .data-table tbody tr:last-child td {
      border-bottom: none;
    }
    
    .data-table tbody tr:hover {
      background: rgba(255, 255, 255, 0.02);
    }
    
    .data-table a {
      color: var(--accent-cyan);
      text-decoration: none;
      transition: color 0.2s;
    }
    
    .data-table a:hover {
      color: var(--accent-purple);
    }
    
    /* çŠ¶æ€æ ‡ç­¾ */
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
    }
    
    .status-pending {
      background: rgba(255, 165, 0, 0.15);
      color: #ffaa00;
    }
    
    .status-completed {
      background: rgba(0, 255, 0, 0.15);
      color: var(--accent-green);
    }
    
    .status-failed {
      background: rgba(255, 0, 0, 0.15);
      color: var(--accent-red);
    }
    
    .status-active {
      background: rgba(0, 255, 255, 0.15);
      color: var(--accent-cyan);
    }
    
    /* ç©ºçŠ¶æ€ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    /* æ¨¡æ€æ¡† */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
    }
    
    .modal-content {
      background: var(--bg-card);
      margin: 5% auto;
      padding: 40px;
      border: 1px solid var(--border-color);
      border-radius: 16px;
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    
    .modal-title {
      font-size: 24px;
      font-weight: 600;
    }
    
    .close {
      color: var(--text-secondary);
      font-size: 28px;
      font-weight: 300;
      cursor: pointer;
      transition: color 0.2s;
      line-height: 1;
    }
    
    .close:hover {
      color: var(--text-primary);
    }
    
    .result-success {
      color: var(--accent-green);
    }
    
    .result-error {
      color: var(--accent-red);
    }
    
    .result-warning {
      color: #ffaa00;
    }
    
    pre {
      background: rgba(0, 0, 0, 0.5);
      padding: 16px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 13px;
      border: 1px solid var(--border-color);
    }
    
    /* åˆ·æ–°æŒ‰é’® */
    .btn-refresh {
      padding: 10px 20px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .btn-refresh:hover {
      border-color: var(--accent-cyan);
      background: rgba(0, 255, 255, 0.05);
    }
    
    /* æ»šåŠ¨æ¡ */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    /* ç”¨æˆ·è¡¨æ ¼ä¸“ç”¨æ ·å¼ */
    .user-account {
      font-weight: 600;
      color: var(--text-primary);
      word-break: break-all;
    }
    
    .user-password {
      font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
      color: var(--accent-cyan);
      letter-spacing: 0.4px;
    }

    .user-token {
      font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
      color: var(--text-secondary);
      max-width: 320px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡† */
    .image-modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(10px);
      cursor: pointer;
    }
    
    .image-modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .image-modal-content {
      max-width: 90vw;
      max-height: 90vh;
      object-fit: contain;
      border-radius: 8px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: zoomIn 0.3s ease-out;
    }
    
    @keyframes zoomIn {
      from {
        transform: scale(0.8);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    .image-modal-info {
      position: absolute;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      padding: 12px 24px;
      border-radius: 8px;
      color: var(--text-primary);
      text-align: center;
    }
    
    .image-modal-close {
      position: absolute;
      top: 20px;
      right: 30px;
      color: var(--text-primary);
      font-size: 40px;
      font-weight: 300;
      cursor: pointer;
      transition: all 0.2s;
      z-index: 2001;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.5);
    }
    
    .image-modal-close:hover {
      background: rgba(255, 0, 0, 0.7);
      transform: rotate(90deg);
    }
    
    /* å“åº”å¼ */
    @media (max-width: 768px) {
      .container {
        padding: 40px 20px;
      }
      
      .hero-title {
        font-size: 36px;
      }
      
      .card-grid {
        grid-template-columns: 1fr;
      }
      
      .control-grid {
        grid-template-columns: 1fr;
      }
      
      .users-image-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 12px;
      }
      
      .user-image-preview {
        height: 150px;
      }
    }
  </style>
</head>
<body data-user-page="{{ user_page or 1 }}" data-task-page="{{ task_page or 1 }}">
  <!-- å¯¼èˆªæ  -->
  <nav class="navbar">
    <a href="/" class="navbar-brand" data-i18n="nav.brand">Makeup Bot</a>
    <div class="navbar-actions">
      <a href="/admin/images" class="btn-admin" data-i18n="nav.images">ğŸ“· ç”¨æˆ·å¤´åƒé…ç½®</a>
      <div class="lang-switcher">
        <button class="lang-btn active" onclick="switchLang('zh')" data-lang="zh">ä¸­æ–‡</button>
        <button class="lang-btn" onclick="switchLang('en')" data-lang="en">English</button>
      </div>
      <button class="btn-logout" onclick="handleLogout()" data-i18n="nav.logout">é€€å‡ºç™»å½•</button>
    </div>
  </nav>

  <div class="container">
    <!-- æ ‡é¢˜åŒºåŸŸ -->
    <div class="hero-section">
      <h1 class="hero-title" data-i18n="hero.title">Control Center</h1>
      <p class="hero-subtitle" data-i18n="hero.subtitle">Automated Makeup Bot Management System</p>
    </div>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="control-section">
      <h2 class="section-title" data-i18n="control.title">System Control</h2>
      <div class="control-grid">
        <a href="/admin/generate-tasks" class="btn-primary" data-i18n="control.generate">âš¡ Generate Tasks</a>
        <button class="btn-module" onclick="callModule('/admin/create-user-once', '1. CREATE USER')" data-i18n="module.create_user">1. Create User</button>
        <button class="btn-module" onclick="callModule('/admin/module/checkin', '2. CHECK-IN')" data-i18n="module.checkin">2. Check-in</button>
        <button class="btn-module" onclick="callModule('/admin/module/face-upload', '3. FACE UPLOAD')" data-i18n="module.face_upload">3. Face Upload</button>
        <button class="btn-module" onclick="callModule('/admin/module/makeup-creation', '4. MAKEUP CREATION')" data-i18n="module.makeup_creation">4. Makeup Creation</button>
        <button class="btn-module" onclick="callModule('/admin/module/post-community', '5. POST TO COMMUNITY')" data-i18n="module.post_community">5. Post to Community</button>
        <button class="btn-module" onclick="callModule('/admin/module/like-collect', '6. LIKE & COLLECT')" data-i18n="module.like_collect">6. Like & Collect</button>
        <button class="btn-module" onclick="callModule('/admin/module/like-comment', '7. LIKE COMMENT')" data-i18n="module.like_comment">7. Like Comment</button>
        <button class="btn-module" onclick="callModule('/admin/module/follow-user', '8. FOLLOW USER')" data-i18n="module.follow_user">8. Follow User</button>
        <button class="btn-module" onclick="callModule('/admin/module/collect-topic', '9. COLLECT TOPIC')" data-i18n="module.collect_topic">9. Collect Topic</button>
      </div>
    </div>

    <!-- ç»“æœæ¨¡æ€æ¡† -->
    <div id="resultModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="modalTitle">Execution Result</h2>
          <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div id="modalBody"></div>
      </div>
    </div>
    
    <!-- åˆ‡æ¢ Tab -->
    <div class="tab-nav">
      <button class="tab-btn active" data-tab="tab-users" data-i18n="tab.users">User List</button>
      <button class="tab-btn" data-tab="tab-tasks" data-i18n="tab.tasks">Today's Tasks</button>
      <button class="tab-btn" data-tab="tab-execution" data-i18n="tab.execution">Today's Execution Log</button>
    </div>

    <!-- ç”¨æˆ·åˆ—è¡¨ -->
    <div class="data-section tab-section" id="tab-users">
      <div class="data-header">
        <h2 class="section-title" data-i18n="users.title">ç”¨æˆ·åˆ—è¡¨</h2>
        <div class="inline-actions">
          <div class="filter-container">
            <div class="filter-group">
              <label class="filter-label" for="users-start" data-i18n="users.start">å¼€å§‹æ—¶é—´</label>
              <input type="datetime-local" step="1" id="users-start" class="filter-input" />
            </div>
            <div class="filter-group">
              <label class="filter-label" for="users-end" data-i18n="users.end">ç»“æŸæ—¶é—´</label>
              <input type="datetime-local" step="1" id="users-end" class="filter-input" />
            </div>
            <div style="display: flex; align-items: flex-end; gap: 8px;">
              <button class="btn-filter" onclick="loadUsers(1)" data-i18n="users.filter">ğŸ” ç­›é€‰</button>
              <button class="btn-filter-reset" onclick="resetUserFilter()" data-i18n="users.reset">ğŸ”„ é‡ç½®</button>
            </div>
          </div>
        </div>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th data-i18n="users.id">ç”¨æˆ·ID</th>
            <th data-i18n="users.account">è´¦å·</th>
            <th data-i18n="users.password">å¯†ç </th>
            <th data-i18n="users.created">åˆ›å»ºæ—¶é—´</th>
            <th data-i18n="users.status">çŠ¶æ€</th>
            <th data-i18n="users.token">Token</th>
          </tr>
        </thead>
        <tbody id="users-tbody">
          <tr>
            <td colspan="6" class="empty-state" data-i18n="users.empty">Loading...</td>
          </tr>
        </tbody>
      </table>
      <div class="pagination-row">
        <div class="data-count" id="users-total" data-i18n="users.count" data-count="0">æ€»è®¡: 0 æ¡è®°å½•</div>
        <div class="pagination" id="users-pagination"></div>
      </div>
    </div>

    <!-- å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡† -->
    <div class="image-modal" id="imageModal" onclick="closeImageModal()">
      <span class="image-modal-close" onclick="closeImageModal()">&times;</span>
      <img class="image-modal-content" id="modalImage" src="" alt="">
      <div class="image-modal-info" id="modalImageInfo"></div>
    </div>

    <!-- ä»Šæ—¥ä»»åŠ¡ -->
    <div class="data-section tab-section" id="tab-tasks" style="display:none;">
      <div class="data-header">
        <h2 class="section-title" data-i18n="tasks.title">ä»»åŠ¡</h2>
        <div class="inline-actions">
          <div class="filter-container">
            <div class="filter-group">
              <label class="filter-label" for="tasks-type" data-i18n="tasks.type_filter">ä»»åŠ¡ç±»å‹</label>
              <select id="tasks-type" class="filter-input">
                <option value="">å…¨éƒ¨</option>
                <option value="create_user">åˆ›å»ºç”¨æˆ·</option>
                <option value="checkin">ç­¾åˆ°</option>
                <option value="face_upload">ä¸Šä¼ äººè„¸</option>
                <option value="makeup_creation">åˆ›å»ºå¦†é€ </option>
                <option value="post_community">å‘å¸ƒåˆ°ç¤¾åŒº</option>
                <option value="like_collect">ç‚¹èµæ”¶è—</option>
                <option value="like_comment">ç‚¹èµè¯„è®º</option>
                <option value="follow_user">å…³æ³¨ç”¨æˆ·</option>
                <option value="collect_topic">æ”¶è—è¯é¢˜</option>
              </select>
            </div>
            <div class="filter-group">
              <label class="filter-label" for="tasks-start" data-i18n="tasks.start">å¼€å§‹æ—¶é—´</label>
              <input type="datetime-local" step="1" id="tasks-start" class="filter-input" />
            </div>
            <div class="filter-group">
              <label class="filter-label" for="tasks-end" data-i18n="tasks.end">ç»“æŸæ—¶é—´</label>
              <input type="datetime-local" step="1" id="tasks-end" class="filter-input" />
            </div>
            <div style="display: flex; align-items: flex-end; gap: 8px;">
              <button class="btn-filter" onclick="loadTasks(1)" data-i18n="tasks.filter">ğŸ” ç­›é€‰</button>
              <button class="btn-filter-reset" onclick="resetTaskFilter()" data-i18n="tasks.reset">ğŸ”„ é‡ç½®</button>
            </div>
          </div>
        </div>
      </div>
      {% if tasks|length > 0 %}
      <table class="data-table">
        <thead>
          <tr>
            <th data-i18n="tasks.id">Task ID</th>
            <th data-i18n="tasks.type">Type</th>
            <th data-i18n="tasks.user">User ID</th>
            <th data-i18n="tasks.user_email">User Email</th>
            <th data-i18n="tasks.scheduled">Scheduled At</th>
            <th data-i18n="tasks.status">Status</th>
            <th data-i18n="tasks.attempts">Attempts</th>
          </tr>
        </thead>
        <tbody id="tasks-tbody">
          <tr><td colspan="7" class="empty-state">Loading...</td></tr>
        </tbody>
      </table>
      <div class="pagination-row">
        <div class="data-count" id="tasks-total" data-i18n="tasks.count" data-count="0">æ€»è®¡: 0 ä¸ªä»»åŠ¡</div>
        <div class="pagination" id="tasks-pagination"></div>
      </div>
      {% else %}
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“‹</div>
        <div data-i18n="tasks.empty">No tasks for today</div>
      </div>
      {% endif %}
    </div>

    <!-- ä»Šæ—¥æ‰§è¡Œæ—¥å¿— -->
    <div class="data-section tab-section" id="tab-execution" style="display:none;">
      <div class="data-header">
        <h2 class="section-title" data-i18n="execution.title">Today's Execution Log</h2>
        <button class="btn-refresh" onclick="loadTaskProgress()" data-i18n="common.refresh">ğŸ”„ Refresh</button>
      </div>
      <table class="data-table" id="progress-table">
        <thead>
          <tr>
            <th data-i18n="execution.user_id">User ID</th>
            <th data-i18n="execution.user_email">User Email</th>
            <th data-i18n="execution.action">Action</th>
            <th data-i18n="execution.api">API Endpoint</th>
            <th data-i18n="execution.time">Executed At</th>
            <th data-i18n="execution.status">Status</th>
            <th data-i18n="execution.message">Message</th>
          </tr>
        </thead>
        <tbody id="executed-tbody">
          <tr>
            <td colspan="7" class="empty-state" data-i18n="execution.empty">Click "Refresh" to load data</td>
          </tr>
        </tbody>
      </table>
      <div class="pagination-row">
        <div class="data-count" id="executed-total" data-i18n="executed.count" data-count="0">æ€»è®¡: 0 æ¬¡æ‰§è¡Œ</div>
        <div class="pagination" id="executed-pagination"></div>
      </div>
    </div>
  </div>
  
  <script>
    // Tokenç®¡ç†
    const TOKEN_KEY = 'admin_token';
    
    /**
     * è·å–token
     * @returns {string|null} tokenå­—ç¬¦ä¸²æˆ–null
     */
    function getToken() {
      return localStorage.getItem(TOKEN_KEY);
    }
    
    /**
     * æ£€æŸ¥æ˜¯å¦å·²ç™»å½•ï¼Œå¦‚æœæœªç™»å½•åˆ™è·³è½¬åˆ°ç™»å½•é¡µ
     * æ³¨æ„ï¼šç°åœ¨ä½¿ç”¨ cookie è®¤è¯ï¼ŒæœåŠ¡å™¨ç«¯ä¼šè‡ªåŠ¨å¤„ç†é‡å®šå‘
     * è¿™ä¸ªå‡½æ•°ä¸»è¦ç”¨äº API è¯·æ±‚æ—¶çš„ token æ£€æŸ¥
     */
    function checkAuth() {
      // ä¸å†è‡ªåŠ¨é‡å®šå‘ï¼Œå› ä¸ºæœåŠ¡å™¨ç«¯å·²ç»å¤„ç†äº†è®¤è¯
      // å¦‚æœç”¨æˆ·è®¿é—®é¦–é¡µä½†æ²¡æœ‰æœ‰æ•ˆçš„ cookieï¼ŒæœåŠ¡å™¨ä¼šé‡å®šå‘åˆ°ç™»å½•é¡µ
      const token = getToken();
      return !!token; // åªè¿”å›æ˜¯å¦æœ‰ tokenï¼Œä¸è‡ªåŠ¨é‡å®šå‘
    }
    
    /**
     * ç»Ÿä¸€çš„fetchè¯·æ±‚å‡½æ•°ï¼Œè‡ªåŠ¨æ·»åŠ token
     * @param {string} url - è¯·æ±‚URL
     * @param {Object} options - fetché€‰é¡¹
     * @returns {Promise<Response>} fetchå“åº”
     */
    async function authFetch(url, options = {}) {
      // å°è¯•ä» localStorage è·å– tokenï¼ˆç”¨äº API è¯·æ±‚ï¼‰
      const token = getToken();
      
      // æ·»åŠ tokenåˆ°headersï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
      const headers = {
        ...options.headers,
      };
      if (token) {
        headers['X-Token'] = token;
      }
      
      // è®¾ç½®è¶…æ—¶ï¼ˆé»˜è®¤ 120 ç§’ï¼Œå¯¹äºé•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡ï¼‰
      const timeout = options.timeout || 120000; // 120ç§’
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
      
      try {
        const response = await fetch(url, {
          ...options,
          headers,
          signal: controller.signal,
        });
        
        clearTimeout(timeoutId);
        
        // å¦‚æœè¿”å›401ï¼Œæ¸…é™¤tokenå¹¶è·³è½¬åˆ°ç™»å½•é¡µ
        if (response.status === 401) {
          localStorage.removeItem(TOKEN_KEY);
          window.location.href = '/login.html';
          return Promise.reject(new Error('è®¤è¯å¤±è´¥'));
        }
        
        return response;
      } catch (error) {
        clearTimeout(timeoutId);
        if (error.name === 'AbortError') {
          throw new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•');
        }
        throw error;
      }
    }
    
    /**
     * å¤„ç†é€€å‡ºç™»å½•
     */
    async function handleLogout() {
      if (!confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        return;
      }
      
      try {
        // è°ƒç”¨é€€å‡ºç™»å½•API
        await fetch('/auth/logout', {
          method: 'POST',
          credentials: 'include', // ç¡®ä¿å‘é€cookie
        });
      } catch (error) {
        console.error('Logout error:', error);
      } finally {
        // æ— è®ºAPIè°ƒç”¨æ˜¯å¦æˆåŠŸï¼Œéƒ½æ¸…é™¤æœ¬åœ°tokenå¹¶è·³è½¬
        localStorage.removeItem(TOKEN_KEY);
        window.location.href = '/login.html';
      }
    }
    
    // ä¸å†åœ¨é¡µé¢åŠ è½½æ—¶æ£€æŸ¥tokenï¼Œå› ä¸ºæœåŠ¡å™¨ç«¯å·²ç»å¤„ç†äº†è®¤è¯
    // å¦‚æœç”¨æˆ·æ²¡æœ‰æœ‰æ•ˆçš„ cookieï¼ŒæœåŠ¡å™¨ä¼šé‡å®šå‘åˆ°ç™»å½•é¡µ
    
    // è¯­è¨€åŒ…
    const i18n = {
      zh: {
        'title': 'Makeup Bot æ§åˆ¶ä¸­å¿ƒ',
        'nav.brand': 'Makeup Bot',
        'nav.images': 'ğŸ“· ç”¨æˆ·å¤´åƒé…ç½®',
        'hero.title': 'æ§åˆ¶ä¸­å¿ƒ',
        'hero.subtitle': 'è‡ªåŠ¨åŒ–å¦†é€ æœºå™¨äººç®¡ç†ç³»ç»Ÿ',
        'control.title': 'ç³»ç»Ÿæ§åˆ¶',
        'control.generate': 'âš¡ ç”Ÿæˆä»»åŠ¡',
        'module.create_user': '1. åˆ›å»ºç”¨æˆ·',
        'module.checkin': '2. ç­¾åˆ°',
        'module.face_upload': '3. ä¸Šä¼ äººè„¸',
        'module.makeup_creation': '4. åˆ›å»ºå¦†é€ ',
        'module.post_community': '5. å‘å¸ƒåˆ°ç¤¾åŒº',
        'module.like_collect': '6. ç‚¹èµæ”¶è—',
        'module.like_comment': '7. ç‚¹èµè¯„è®º',
        'module.follow_user': '8. å…³æ³¨ç”¨æˆ·',
        'module.collect_topic': '9. æ”¶è—è¯é¢˜',
        'execution.title': 'ä»Šæ—¥æ‰§è¡Œæ—¥å¿—',
        'execution.user_id': 'ç”¨æˆ·ID',
        'execution.action': 'åŠ¨ä½œ',
        'execution.api': 'APIç«¯ç‚¹',
        'execution.time': 'æ‰§è¡Œæ—¶é—´',
        'execution.status': 'çŠ¶æ€',
        'execution.message': 'æ¶ˆæ¯',
        'execution.empty': 'ç‚¹å‡»â€œåˆ·æ–°â€åŠ è½½æ•°æ®',
        'tab.execution': 'ä»Šæ—¥æ‰§è¡Œæ—¥å¿—',
        'tab.users': 'ç”¨æˆ·åˆ—è¡¨',
        'tab.tasks': 'ä»»åŠ¡',
        'users.title': 'ç”¨æˆ·åˆ—è¡¨',
        'users.count': 'æ€»è®¡: {count} æ¡è®°å½•',
        'users.id': 'ç”¨æˆ·ID',
        'users.account': 'è´¦å·',
        'users.password': 'å¯†ç ',
        'users.token': 'Token',
        'users.email': 'é‚®ç®±',
        'users.created': 'åˆ›å»ºæ—¶é—´',
        'users.status': 'çŠ¶æ€',
        'users.more': 'æ˜¾ç¤ºå‰20æ¡ï¼Œå…± {count} ä¸ªç”¨æˆ·',
        'users.empty': 'æš‚æ— ç”¨æˆ·',
        'users.start': 'å¼€å§‹æ—¶é—´',
        'users.end': 'ç»“æŸæ—¶é—´',
        'users.filter': 'ç­›é€‰',
        'users.reset': 'é‡ç½®',
        'tasks.title': 'ä»»åŠ¡',
        'tasks.count': 'æ€»è®¡: {count} ä¸ªä»»åŠ¡',
        'tasks.id': 'ä»»åŠ¡ID',
        'tasks.type': 'ç±»å‹',
        'tasks.user': 'ç”¨æˆ·ID',
        'tasks.user_email': 'ç”¨æˆ·é‚®ç®±',
        'tasks.scheduled': 'è®¡åˆ’æ—¶é—´',
        'tasks.status': 'çŠ¶æ€',
        'tasks.attempts': 'å°è¯•æ¬¡æ•°',
        'tasks.start': 'å¼€å§‹æ—¥æœŸ',
        'tasks.end': 'ç»“æŸæ—¥æœŸ',
        'tasks.filter': 'ç­›é€‰',
        'tasks.reset': 'é‡ç½®',
        'tasks.empty': 'ä»Šæ—¥æš‚æ— ä»»åŠ¡',
        'executed.title': 'ä»Šæ—¥æ‰§è¡Œä»»åŠ¡',
        'executed.count': 'æ€»è®¡: {count} æ¬¡æ‰§è¡Œ',
        'executed.user_id': 'ç”¨æˆ·ID',
        'executed.user_email': 'ç”¨æˆ·é‚®ç®±',
        'executed.action': 'åŠ¨ä½œ',
        'executed.api': 'APIç«¯ç‚¹',
        'executed.time': 'æ‰§è¡Œæ—¶é—´',
        'executed.status': 'çŠ¶æ€',
        'executed.empty': 'ä»Šæ—¥æš‚æ— æ‰§è¡Œä»»åŠ¡',
        'common.refresh': 'ğŸ”„ åˆ·æ–°'
      },
      en: {
        'title': 'Makeup Bot Control Center',
        'nav.brand': 'Makeup Bot',
        'nav.images': 'ğŸ“· User Avatar Config',
        'nav.logout': 'Logout',
        'hero.title': 'Control Center',
        'hero.subtitle': 'Automated Makeup Bot Management System',
        'control.title': 'System Control',
        'control.generate': 'âš¡ Generate Tasks',
        'module.create_user': '1. Create User',
        'module.checkin': '2. Check-in',
        'module.face_upload': '3. Face Upload',
        'module.makeup_creation': '4. Makeup Creation',
        'module.post_community': '5. Post to Community',
        'module.like_collect': '6. Like & Collect',
        'module.like_comment': '7. Like Comment',
        'module.follow_user': '8. Follow User',
        'module.collect_topic': '9. Collect Topic',
        'execution.title': 'Today\'s Execution Log',
        'execution.user_id': 'User ID',
        'execution.action': 'Action',
        'execution.api': 'API Endpoint',
        'execution.time': 'Executed At',
        'execution.status': 'Status',
        'execution.message': 'Message',
        'execution.empty': 'Click "Refresh" to load data',
        'tab.execution': "Today's Execution Log",
        'tab.users': 'User List',
        'tab.tasks': 'Tasks',
        'users.title': 'User List',
        'users.count': 'Total: {count} records',
        'users.id': 'User ID',
        'users.account': 'Account',
        'users.password': 'Password',
        'users.token': 'Token',
        'users.email': 'Email',
        'users.created': 'Created At',
        'users.status': 'Status',
        'users.more': 'Showing first 20 of {count} users',
        'users.empty': 'No users found',
        'tasks.title': 'Tasks',
        'tasks.count': 'Total: {count} tasks',
        'tasks.id': 'Task ID',
        'tasks.type': 'Type',
        'tasks.user': 'User ID',
        'tasks.user_email': 'User Email',
        'tasks.scheduled': 'Scheduled At',
        'tasks.status': 'Status',
        'tasks.attempts': 'Attempts',
        'tasks.start': 'Start Date',
        'tasks.end': 'End Date',
        'tasks.filter': 'Filter',
        'tasks.reset': 'Reset',
        'tasks.empty': 'No tasks for today',
        'executed.title': 'Today\'s Executed Tasks',
        'executed.count': 'Total: {count} executions',
        'executed.user_id': 'User ID',
        'executed.user_email': 'User Email',
        'executed.action': 'Action',
        'executed.api': 'API Endpoint',
        'executed.time': 'Executed At',
        'executed.status': 'Status',
        'executed.empty': 'No executed tasks today',
        'common.refresh': 'ğŸ”„ Refresh'
      }
    };
    
    // å½“å‰è¯­è¨€
    let currentLang = localStorage.getItem('lang') || 'zh';
    
    // åˆ‡æ¢è¯­è¨€
    function switchLang(lang) {
      currentLang = lang;
      localStorage.setItem('lang', lang);
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-lang') === lang) {
          btn.classList.add('active');
        }
      });
      
      // æ›´æ–°æ‰€æœ‰æ–‡æœ¬
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (i18n[lang] && i18n[lang][key]) {
          let text = i18n[lang][key];
          // å¤„ç†æ¨¡æ¿å˜é‡ - ä»data-countå±æ€§è·å–
          const count = el.getAttribute('data-count');
          if (count !== null && text.includes('{count}')) {
            text = text.replace(/{count}/g, count);
          }
          el.textContent = text;
        }
      });
      
      // æ›´æ–°é¡µé¢æ ‡é¢˜
      document.title = i18n[lang]['title'];
    }
    
    // é¡µé¢åŠ è½½æ—¶åº”ç”¨è¯­è¨€ & åˆå§‹åŒ–tab
    window.addEventListener('DOMContentLoaded', () => {
      const initialUserPage = Number(document.body.getAttribute('data-user-page') || 1);
      const initialTaskPage = Number(document.body.getAttribute('data-task-page') || 1);
      switchLang(currentLang);
      initTabs();
      loadTaskProgress();
      initUserFilter();
      loadUsers(initialUserPage);
      initTaskFilter();
      loadTasks(initialTaskPage);
    });

    // Tab åˆ‡æ¢
    function initTabs() {
      const tabs = document.querySelectorAll('.tab-btn');
      const sections = document.querySelectorAll('.tab-section');
      const urlParams = new URLSearchParams(window.location.search);
      const initialTab = urlParams.get('tab') || 'users';
      tabs.forEach(btn => {
        btn.addEventListener('click', () => {
          tabs.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          const target = btn.getAttribute('data-tab');
          sections.forEach(sec => {
            sec.style.display = sec.id === target ? 'block' : 'none';
          });
          const params = new URLSearchParams(window.location.search);
          params.set('tab', target.replace('tab-', ''));
          window.history.replaceState({}, '', `${location.pathname}?${params.toString()}`);
        });
      });
      const targetId = `tab-${initialTab}`;
      const targetBtn = Array.from(tabs).find(b => b.getAttribute('data-tab') === targetId) || tabs[0];
      if (targetBtn) targetBtn.click();
    }
    
    /**
     * åŠ è½½ä»»åŠ¡è¿›åº¦
     */
    function loadTaskProgress(page = 1) {
      loadSection('/api/executed', page, PAGE_SIZE, renderExecutedTable);
    }

    // é€šç”¨åˆ†é¡µåŠ è½½
    const PAGE_SIZE = 20;

    /**
     * æ›´æ–°æ•°æ®æ€»æ•°æ–‡æ¡ˆã€‚
     * @param {string} elId - ç›®æ ‡å…ƒç´  IDã€‚
     * @param {string} i18nKey - i18n æ–‡æ¡ˆé”®ã€‚
     * @param {number} count - æ€»æ•°ã€‚
     */
    function updateCountText(elId, i18nKey, count) {
      const el = document.getElementById(elId);
      if (!el) return;
      const safeCount = count === undefined || count === null ? 0 : count;
      el.setAttribute('data-count', safeCount);
      const langPack = i18n[currentLang];
      if (langPack && langPack[i18nKey]) {
        el.textContent = langPack[i18nKey].replace(/{count}/g, safeCount);
      } else {
        el.textContent = `Total: ${safeCount}`;
      }
    }

    function loadSection(apiUrl, page, pageSize = PAGE_SIZE, renderFn) {
      authFetch(`${apiUrl}?page=${page}&page_size=${pageSize}`)
        .then(res => res.json())
        .then(json => renderFn(json))
        .catch(err => {
          console.error('loadSection error', err);
          if (err.message !== 'æœªç™»å½•' && err.message !== 'è®¤è¯å¤±è´¥') {
            // åªæœ‰éè®¤è¯é”™è¯¯æ‰æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
          }
        });
    }

    /**
     * åˆå§‹åŒ–ç”¨æˆ·ç­›é€‰å™¨ï¼ˆé»˜è®¤ä¸ºç©ºï¼Œä¸è®¾ç½®æ—¥æœŸï¼‰ã€‚
     */
    function initUserFilter() {
      const start = document.getElementById('users-start');
      const end = document.getElementById('users-end');
      // é»˜è®¤ä¸è®¾ç½®æ—¥æœŸï¼Œè¿”å›å…¨é‡æ•°æ®
      if (start) start.value = '';
      if (end) end.value = '';
    }

    /**
     * è·å–ç”¨æˆ·ç­›é€‰å‚æ•°ã€‚
     * @returns {Object} start å’Œ end çš„æ—¥æœŸå­—ç¬¦ä¸²
     */
    function getUserFilter() {
      const start = document.getElementById('users-start')?.value || '';
      const end = document.getElementById('users-end')?.value || '';
      return { start, end };
    }

    /**
     * é‡ç½®ç”¨æˆ·ç­›é€‰ï¼ˆæ¸…ç©ºæ—¥æœŸï¼‰å¹¶åˆ·æ–°ã€‚
     */
    function resetUserFilter() {
      initUserFilter();
      loadUsers(1);
    }

    /**
     * åŠ è½½ç”¨æˆ·åˆ—è¡¨ï¼ˆæ”¯æŒæ—¥æœŸç­›é€‰ï¼‰ã€‚
     * @param {number} page - é¡µç 
     */
    function loadUsers(page = 1) {
      const { start, end } = getUserFilter();
      const params = new URLSearchParams({
        page,
        page_size: PAGE_SIZE
      });
      if (start) params.append('start_date', start);
      if (end) params.append('end_date', end);
      authFetch(`/api/users?${params.toString()}`)
        .then(res => res.json())
        .then(json => renderUsers(json))
        .catch(err => {
          console.error('loadUsers error', err);
          if (err.message !== 'æœªç™»å½•' && err.message !== 'è®¤è¯å¤±è´¥') {
            // åªæœ‰éè®¤è¯é”™è¯¯æ‰æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
          }
        });
    }

    /**
     * åˆå§‹åŒ–ä»»åŠ¡ç­›é€‰å™¨ï¼ˆé»˜è®¤ä¸ºç©ºï¼Œä¸è®¾ç½®æ—¥æœŸå’Œç±»å‹ï¼‰ã€‚
     */
    function initTaskFilter() {
      const type = document.getElementById('tasks-type');
      const start = document.getElementById('tasks-start');
      const end = document.getElementById('tasks-end');
      // é»˜è®¤ä¸è®¾ç½®ç­›é€‰æ¡ä»¶ï¼Œè¿”å›å…¨é‡æ•°æ®
      if (type) type.value = '';
      if (start) start.value = '';
      if (end) end.value = '';
    }

    /**
     * è·å–ä»»åŠ¡ç­›é€‰å‚æ•°ã€‚
     * @returns {Object} typeã€start å’Œ end çš„ç­›é€‰å€¼
     */
    function getTaskFilter() {
      const type = document.getElementById('tasks-type')?.value || '';
      const start = document.getElementById('tasks-start')?.value || '';
      const end = document.getElementById('tasks-end')?.value || '';
      return { type, start, end };
    }

    /**
     * é‡ç½®ä»»åŠ¡ç­›é€‰ï¼ˆæ¸…ç©ºæ—¥æœŸï¼‰å¹¶åˆ·æ–°ã€‚
     */
    function resetTaskFilter() {
      initTaskFilter();
      loadTasks(1);
    }

    /**
     * åŠ è½½ä»»åŠ¡ï¼ˆæ”¯æŒä»»åŠ¡ç±»å‹å’Œæ—¥æœŸç­›é€‰ï¼‰ã€‚
     * @param {number} page - é¡µç 
     */
    function loadTasks(page = 1) {
      const { type, start, end } = getTaskFilter();
      const params = new URLSearchParams({
        page,
        page_size: PAGE_SIZE
      });
      if (type) params.append('task_type', type);
      if (start) params.append('start_date', start);
      if (end) params.append('end_date', end);
      authFetch(`/api/tasks?${params.toString()}`)
        .then(res => res.json())
        .then(json => renderTasks(json))
        .catch(err => {
          console.error('loadTasks error', err);
          if (err.message !== 'æœªç™»å½•' && err.message !== 'è®¤è¯å¤±è´¥') {
            // åªæœ‰éè®¤è¯é”™è¯¯æ‰æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
          }
        });
    }

    /**
     * æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨å¹¶å±•ç¤ºè´¦å·ä¸å¯†ç ã€‚
     * @param {Object} json - ç”¨æˆ·åˆ—è¡¨æ•°æ®ï¼ŒåŒ…å« data/page/total/page_sizeã€‚
     */
    function renderUsers(json) {
      const tbody = document.getElementById('users-tbody');
      const pag = document.getElementById('users-pagination');
      tbody.innerHTML = '';
      const data = json.data || [];
      
      if (data.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 5;
        td.className = 'empty-state';
        td.textContent = currentLang === 'zh' ? 'æš‚æ— ç”¨æˆ·' : 'No users found';
        tr.appendChild(td);
        tbody.appendChild(tr);
      } else {
        data.forEach(u => {
          // è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ï¼Œé¿å… XSS
          const safeEmail = (u.email || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
          const safeUsername = (u.username || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
          const safePassword = (u.password_plain || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
          const safeToken = (u.token || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
          const createdAt = u.created_at_str || '';
          const status = u.status || '';
          
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${u.id === undefined || u.id === null ? '-' : u.id}</td>
            <td class="user-account" title="${safeEmail || safeUsername || 'N/A'}">${safeEmail || safeUsername || 'N/A'}</td>
            <td class="user-password">${safePassword || 'N/A'}</td>
            <td>${createdAt}</td>
            <td><span class="status-badge status-${(status || '').toLowerCase()}">${status}</span></td>
            <td class="user-token" title="${safeToken || 'N/A'}">${safeToken || 'N/A'}</td>
          `;
          tbody.appendChild(tr);
        });
      }
      
      updateCountText('users-total', 'users.count', json.total || 0);
      renderPagination(pag, json.page, Math.max(1, Math.ceil((json.total || 0) / (json.page_size || PAGE_SIZE))), 'users', json.page_size || PAGE_SIZE);
    }

    /**
     * ä»»åŠ¡ç±»å‹æ˜ å°„ä¸ºå¯è¯»åŠ¨ä½œã€‚
     * @param {string} type - ä»»åŠ¡ç±»å‹æ ‡è¯†ã€‚
     * @returns {string} å¯è¯»çš„åŠ¨ä½œåç§°ã€‚
     */
    function mapTaskType(type) {
      const map = {
        register: 'åˆ›å»ºç”¨æˆ·',
        create_user: 'åˆ›å»ºç”¨æˆ·',
        checkin: 'ç­¾åˆ°',
        face_upload: 'ä¸Šä¼ äººè„¸',
        makeup_creation: 'åˆ›å»ºå¦†é€ ',
        post_community: 'å‘å¸ƒåˆ°ç¤¾åŒº',
        like_collect: 'ç‚¹èµæ”¶è—',
        like_comment: 'ç‚¹èµè¯„è®º',
        follow_user: 'å…³æ³¨ç”¨æˆ·',
        collect_topic: 'æ”¶è—è¯é¢˜',
        login: 'ç™»å½•',
        post: 'å‘å¸ƒ',
        makeup: 'å¦†é€ ',
        beauty_flow: 'ç¾å¦†æµç¨‹'
      };
      return map[type] || type || '';
    }

    /**
     * æ‰“å¼€å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡†
     * @param {string} imageUrl - å›¾ç‰‡URL
     * @param {string} email - ç”¨æˆ·é‚®ç®±
     * @param {number} userId - ç”¨æˆ·ID
     */
    function openImageModal(imageUrl, email, userId) {
      const modal = document.getElementById('imageModal');
      const modalImage = document.getElementById('modalImage');
      const modalInfo = document.getElementById('modalImageInfo');
      
      modalImage.src = imageUrl;
      modalInfo.innerHTML = `
        <div><strong>ç”¨æˆ·ID:</strong> ${userId}</div>
        <div><strong>é‚®ç®±:</strong> ${email}</div>
        <div style="margin-top: 8px; opacity: 0.7; font-size: 12px;">ç‚¹å‡»ä»»æ„ä½ç½®å…³é—­</div>
      `;
      
      modal.classList.add('active');
      document.body.style.overflow = 'hidden'; // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
    }

    /**
     * å…³é—­å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡†
     */
    function closeImageModal() {
      const modal = document.getElementById('imageModal');
      modal.classList.remove('active');
      document.body.style.overflow = ''; // æ¢å¤æ»šåŠ¨
    }

    // ESCé”®å…³é—­æ¨¡æ€æ¡†
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeImageModal();
      }
    });

    // æ¸²æŸ“ä»»åŠ¡è¡¨
    function renderTasks(json) {
      const tbody = document.getElementById('tasks-tbody');
      const pag = document.getElementById('tasks-pagination');
      tbody.innerHTML = '';
      const data = json.data || [];
      if (data.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 6;
        td.className = 'empty-state';
        td.textContent = currentLang === 'zh' ? 'ä»Šæ—¥æš‚æ— ä»»åŠ¡' : 'No tasks for today';
        tr.appendChild(td);
        tbody.appendChild(tr);
      } else {
        data.forEach(t => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${t.id}</td>
            <td>${mapTaskType(t.type)}</td>
            <td>${t.user_id || ''}</td>
            <td>${t.user_email || ''}</td>
            <td>${t.scheduled_at_str || ''}</td>
            <td><span class="status-badge status-${(t.status || '').toLowerCase()}">${t.status || ''}</span></td>
            <td>${t.attempts || 0}</td>
          `;
          tbody.appendChild(tr);
        });
      }
      renderPagination(pag, json.page, Math.max(1, Math.ceil((json.total || 0) / (json.page_size || PAGE_SIZE))), 'tasks', json.page_size || PAGE_SIZE);
      updateCountText('tasks-total', 'tasks.count', json.total || 0);
    }

    // æ¸²æŸ“æ‰§è¡Œæ—¥å¿—ï¼ˆè¡¨æ ¼åˆ†é¡µï¼‰
    function renderExecutedTable(json) {
      const tbody = document.getElementById('executed-tbody');
      const pag = document.getElementById('executed-pagination');
      tbody.innerHTML = '';
      const data = json.data || [];
      if (data.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 6;
        td.className = 'empty-state';
        td.textContent = currentLang === 'zh' ? 'æš‚æ— ä»»åŠ¡è®°å½•' : 'No task records';
        tr.appendChild(td);
        tbody.appendChild(tr);
      } else {
        data.forEach(log => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${log.user_id || ''}</td>
            <td>${log.user_email || ''}</td>
            <td>${log.action || ''}</td>
            <td>${log.api_endpoint || ''}</td>
            <td>${log.executed_at_str || ''}</td>
            <td><span class="status-badge status-${(log.status || '').toLowerCase()}">${log.status || ''}</span></td>
            <td>${(log.message || '').substring(0, 50)}</td>
          `;
          tbody.appendChild(tr);
        });
      }
      updateCountText('executed-total', 'executed.count', json.total || 0);
      renderPagination(pag, json.page, Math.max(1, Math.ceil((json.total || 0) / (json.page_size || PAGE_SIZE))), 'executed', json.page_size || PAGE_SIZE);
    }

    // æ¸²æŸ“åˆ†é¡µç»„ä»¶
    function renderPagination(container, page, totalPages, type, pageSize = PAGE_SIZE) {
      if (!container) return;
      container.innerHTML = '';
      container.className = 'pagination';
      const createLink = (text, targetPage, isActive = false) => {
        const a = document.createElement('a');
        a.href = 'javascript:void(0)';
        a.textContent = text;
        a.className = 'page-btn' + (isActive ? ' active' : '');
        a.addEventListener('click', () => {
          if (type === 'users') loadUsers(targetPage);
          if (type === 'tasks') loadTasks(targetPage);
          if (type === 'executed') loadSection('/api/executed', targetPage, pageSize, renderExecutedTable);
        });
        return a;
      };
      const spanInfo = document.createElement('span');
      spanInfo.className = 'page-info';
      spanInfo.textContent = `PAGE ${page} / ${totalPages}`;
      container.appendChild(spanInfo);

      if (page > 1) {
        container.appendChild(createLink('Â«', page - 1));
      }
      for (let p = 1; p <= totalPages; p++) {
        if (p === page) {
          container.appendChild(createLink(String(p), p, true));
        } else if (p === 1 || p === totalPages || (p >= page - 2 && p <= page + 2)) {
          container.appendChild(createLink(String(p), p));
        } else if (p === page - 3 || p === page + 3) {
          const ell = document.createElement('span');
          ell.className = 'ellipsis';
          ell.textContent = '...';
          container.appendChild(ell);
        }
      }
      if (page < totalPages) {
        container.appendChild(createLink('Â»', page + 1));
      }
    }

    /**
     * è°ƒç”¨æ¨¡å—æ¥å£å¹¶æ˜¾ç¤ºç»“æœ
     */
    function callModule(url, title) {
      const modal = document.getElementById('resultModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');
      
      modalTitle.textContent = title + ' - ' + (currentLang === 'zh' ? 'æ‰§è¡Œä¸­...' : 'Executing...');
      modalBody.innerHTML = '<p>' + (currentLang === 'zh' ? 'æ­£åœ¨æ‰§è¡Œï¼Œè¯·ç¨å€™...' : 'Processing, please wait...') + '</p>';
      modal.style.display = 'block';

      authFetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        timeout: 300000  // 5åˆ†é’Ÿè¶…æ—¶ï¼ˆå¯¹äºåˆ›å»ºå¦†å®¹ç­‰é•¿æ—¶é—´ä»»åŠ¡ï¼‰
      })
        .then(async response => {
          // æ£€æŸ¥å“åº”çŠ¶æ€
          if (!response.ok) {
            const text = await response.text();
            throw new Error(`HTTP ${response.status}: ${text.substring(0, 200)}`);
          }
          // æ£€æŸ¥å†…å®¹ç±»å‹
          const contentType = response.headers.get('content-type');
          if (contentType && !contentType.includes('application/json')) {
            const text = await response.text();
            throw new Error(`æœåŠ¡å™¨è¿”å›äº†éJSONå“åº”: ${text.substring(0, 200)}`);
          }
          // å°è¯•è§£æ JSON
          try {
            return await response.json();
          } catch (jsonError) {
            const text = await response.text();
            throw new Error(`JSONè§£æå¤±è´¥: ${jsonError.message}. å“åº”å†…å®¹: ${text.substring(0, 200)}`);
          }
        })
        .then(data => {
          modalTitle.textContent = title + ' - ' + (currentLang === 'zh' ? 'æ‰§è¡Œç»“æœ' : 'Result');
          let html = '';
          
          if (data.data) {
            const result = data.data;
            if (result.success) {
              html += '<p class="result-success"><b>âœ“ ' + (currentLang === 'zh' ? 'æ‰§è¡ŒæˆåŠŸ' : 'Execution Success') + '</b></p>';
            } else {
              html += '<p class="result-error"><b>âœ— ' + (currentLang === 'zh' ? 'æ‰§è¡Œå¤±è´¥' : 'Execution Failed') + '</b></p>';
            }
            
            if (result.user_id) {
              html += '<p><b>' + (currentLang === 'zh' ? 'ç”¨æˆ·ID:' : 'User ID:') + '</b> ' + result.user_id + '</p>';
            }
            if (result.makeup_id) {
              html += '<p><b>' + (currentLang === 'zh' ? 'å¦†é€ ID:' : 'Makeup ID:') + '</b> ' + result.makeup_id + '</p>';
            }
            if (result.post_id) {
              html += '<p><b>' + (currentLang === 'zh' ? 'åŠ¨æ€ID:' : 'Post ID:') + '</b> ' + result.post_id + '</p>';
            }
            if (result.target_user_id) {
              html += '<p><b>' + (currentLang === 'zh' ? 'ç›®æ ‡ç”¨æˆ·ID:' : 'Target User ID:') + '</b> ' + result.target_user_id + '</p>';
            }
            if (result.topic_id) {
              html += '<p><b>' + (currentLang === 'zh' ? 'è¯é¢˜ID:' : 'Topic ID:') + '</b> ' + result.topic_id + '</p>';
            }
            
            if (result.warnings && result.warnings.length > 0) {
              html += '<p class="result-warning"><b>' + (currentLang === 'zh' ? 'è­¦å‘Š:' : 'Warnings:') + '</b></p><ul>';
              result.warnings.forEach(w => {
                html += '<li>' + w + '</li>';
              });
              html += '</ul>';
            }
            
            if (result.error) {
              html += '<p class="result-error"><b>' + (currentLang === 'zh' ? 'é”™è¯¯:' : 'Error:') + '</b></p>';
              html += '<pre>' + JSON.stringify(result.error, null, 2) + '</pre>';
            }
            
            if (result.debug) {
              html += '<p><b>' + (currentLang === 'zh' ? 'è°ƒè¯•ä¿¡æ¯:' : 'Debug Info:') + '</b></p>';
              html += '<pre>' + JSON.stringify(result.debug, null, 2) + '</pre>';
            }
            
            html += '<p><b>' + (currentLang === 'zh' ? 'å®Œæ•´å“åº”:' : 'Full Response:') + '</b></p>';
            html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
          } else {
            html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
          }
          
          modalBody.innerHTML = html;
        })
        .catch(error => {
          modalTitle.textContent = title + ' - ' + (currentLang === 'zh' ? 'é”™è¯¯' : 'Error');
          modalBody.innerHTML = '<p class="result-error"><b>' + (currentLang === 'zh' ? 'è¯·æ±‚å¤±è´¥:' : 'Request Failed:') + '</b> ' + error.message + '</p>';
        });
    }

    /**
     * å…³é—­æ¨¡æ€æ¡†
     */
    function closeModal() {
      document.getElementById('resultModal').style.display = 'none';
    }

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    window.onclick = function(event) {
      const modal = document.getElementById('resultModal');
      if (event.target == modal) {
        closeModal();
      }
    }
    
    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½ä»»åŠ¡è¿›åº¦
    window.addEventListener('DOMContentLoaded', () => {
      loadTaskProgress();
    });
  </script>
</body>
</html>

